{% extends 'base.html' %}
{% load humanize %}

{% block title %}ØªÚ©Ù…ÛŒÙ„ Ø®Ø±ÛŒØ¯{% endblock %}

{% block content %}
<div class="container" style="padding: 40px 0;">
    <h1 style="margin-bottom: 30px; font-size: 1.8rem;">âœ… ØªÚ©Ù…ÛŒÙ„ Ø³ÙØ§Ø±Ø´</h1>

    <div style="display: grid; grid-template-columns: 1fr 380px; gap: 30px;">
        <form method="post">
            {% csrf_token %}

            <!-- Address -->
            <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.08);">
                <h3 style="margin-bottom: 20px; font-size: 1.1rem;">ğŸ“ Ø¢Ø¯Ø±Ø³ ØªØ­ÙˆÛŒÙ„</h3>
                {% for addr in addresses %}
                <label style="display: flex; gap: 15px; padding: 15px; border: 1.5px solid #eee; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;" 
                       onmouseenter="this.style.borderColor='#e94560'" onmouseleave="this.style.borderColor='#eee'">
                    <input type="radio" name="address_id" value="{{ addr.id }}" {% if forloop.first %}checked{% endif %} style="margin-top: 3px;">
                    <div>
                        <div style="font-weight: 600;">{{ addr.title }} - {{ addr.receiver_name }}</div>
                        <div style="color: #666; font-size: 0.85rem;">{{ addr.province }} - {{ addr.city }} - {{ addr.address }}</div>
                        <div style="color: #666; font-size: 0.85rem;">ğŸ“± {{ addr.receiver_phone }}</div>
                    </div>
                </label>
                {% empty %}
                <p style="color: #999;">Ø¢Ø¯Ø±Ø³ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡. <a href="{% url 'accounts:add_address' %}" style="color: var(--accent);">Ø¢Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯</a></p>
                {% endfor %}
                <a href="{% url 'accounts:add_address' %}" style="display: inline-flex; align-items: center; gap: 5px; color: var(--accent); font-size: 0.9rem; margin-top: 10px;">+ Ø¢Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯</a>
            </div>

            <!-- Shipping -->
            <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.08);">
                <h3 style="margin-bottom: 20px; font-size: 1.1rem;">ğŸšš Ø±ÙˆØ´ Ø§Ø±Ø³Ø§Ù„</h3>
                <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1.5px solid #eee; border-radius: 10px; cursor: pointer; margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="radio" name="shipping_method" value="standard" checked>
                        <div><strong>Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³ØªÛŒ</strong><br><small style="color: #666;">Û³-Ûµ Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ</small></div>
                    </div>
                    <span>Ø±Ø§ÛŒÚ¯Ø§Ù† ØªØ§ ÛµÛ°Û°Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†</span>
                </label>
                <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1.5px solid #eee; border-radius: 10px; cursor: pointer; margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="radio" name="shipping_method" value="express">
                        <div><strong>Ø§Ø±Ø³Ø§Ù„ Ø§Ú©Ø³Ù¾Ø±Ø³</strong><br><small style="color: #666;">Û±-Û² Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ</small></div>
                    </div>
                    <span>Û´Ûµ,Û°Û°Û° ØªÙˆÙ…Ø§Ù†</span>
                </label>
                <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1.5px solid #eee; border-radius: 10px; cursor: pointer;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="radio" name="shipping_method" value="tipax">
                        <div><strong>ØªÛŒÙ¾Ø§Ú©Ø³</strong><br><small style="color: #666;">Û²-Û³ Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ</small></div>
                    </div>
                    <span>Û³Ûµ,Û°Û°Û° ØªÙˆÙ…Ø§Ù†</span>
                </label>
            </div>

            <!-- Payment -->
            <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.08);">
                <h3 style="margin-bottom: 20px; font-size: 1.1rem;">ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª</h3>
                <label style="display: flex; gap: 10px; align-items: center; padding: 12px; border: 1.5px solid #eee; border-radius: 10px; cursor: pointer; margin-bottom: 10px;">
                    <input type="radio" name="payment_method" value="online" checked>
                    <div><strong>ğŸ”’ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ†</strong><br><small style="color: #666;">Ø¯Ø±Ú¯Ø§Ù‡ Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„</small></div>
                </label>
                <label style="display: flex; gap: 10px; align-items: center; padding: 12px; border: 1.5px solid #eee; border-radius: 10px; cursor: pointer; margin-bottom: 10px;">
                    <input type="radio" name="payment_method" value="cod">
                    <div><strong>ğŸ’µ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ù…Ø­Ù„</strong><br><small style="color: #666;">Ù‡Ù†Ú¯Ø§Ù… ØªØ­ÙˆÛŒÙ„</small></div>
                </label>
                <label style="display: flex; gap: 10px; align-items: center; padding: 12px; border: 1.5px solid #eee; border-radius: 10px; cursor: pointer;">
                    <input type="radio" name="payment_method" value="wallet">
                    <div><strong>ğŸ‘œ Ú©ÛŒÙ Ù¾ÙˆÙ„</strong><br><small style="color: #666;">Ù…ÙˆØ¬ÙˆØ¯ÛŒ: {{ request.user.wallet_balance|intcomma }} ØªÙˆÙ…Ø§Ù†</small></div>
                </label>
            </div>

            <!-- Coupon -->
            <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.08);">
                <h3 style="margin-bottom: 15px; font-size: 1.1rem;">ğŸŸï¸ Ú©Ø¯ ØªØ®ÙÛŒÙ</h3>
                <div style="display: flex; gap: 10px;">
                    <input type="text" name="coupon_code" id="coupon-input" class="form-control" placeholder="Ú©Ø¯ ØªØ®ÙÛŒÙ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
                    <button type="button" class="btn btn-outline" style="border: 1.5px solid #ddd; color: #333; white-space: nowrap;" onclick="checkCoupon()">Ø§Ø¹Ù…Ø§Ù„</button>
                </div>
                <div id="coupon-result" style="margin-top: 8px; font-size: 0.9rem;"></div>
            </div>

            <!-- Gift Options -->
            <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.08);">
                <h3 style="margin-bottom: 15px; font-size: 1.1rem;">ğŸ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡</h3>
                <label style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" name="is_gift" id="is-gift">
                    <span>Ø¨Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‡Ø¯ÛŒÙ‡</span>
                </label>
                <div id="gift-message-section" style="display: none;">
                    <textarea name="gift_message" class="form-control" rows="2" placeholder="Ù¾ÛŒØ§Ù… Ù‡Ø¯ÛŒÙ‡..."></textarea>
                </div>
                <label style="display: flex; gap: 10px; align-items: center; cursor: pointer;">
                    <input type="checkbox" name="has_insurance">
                    <span>Ø¨ÛŒÙ…Ù‡ Ù…Ø±Ø³ÙˆÙ„Ù‡ (Û±Ûµ,Û°Û°Û° ØªÙˆÙ…Ø§Ù†)</span>
                </label>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 16px; font-size: 1.05rem;">
                âœ… Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ùˆ Ø§Ø¯Ø§Ù…Ù‡
            </button>
        </form>

        <!-- Summary -->
        <div>
            <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); position: sticky; top: 120px;">
                <h3 style="margin-bottom: 20px; font-size: 1.1rem;">Ø®Ù„Ø§ØµÙ‡ Ø³Ø¨Ø¯</h3>
                {% for item in cart %}
                <div style="display: flex; gap: 10px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #eee;">
                    <span style="background: var(--accent); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; flex-shrink: 0;">{{ item.quantity }}</span>
                    <span style="flex: 1; font-size: 0.85rem;">{{ item.variant.product.name }}</span>
                    <span style="font-size: 0.85rem; font-weight: 600;">{{ item.total_price|intcomma }}</span>
                </div>
                {% endfor %}
                <hr style="border: none; border-top: 1px solid #eee; margin: 15px 0;">
                <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.1rem;">
                    <span>Ù…Ø¬Ù…ÙˆØ¹:</span>
                    <span style="color: var(--accent);">{{ cart.grand_total|intcomma }} ØªÙˆÙ…Ø§Ù†</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('is-gift').addEventListener('change', function() {
    document.getElementById('gift-message-section').style.display = this.checked ? 'block' : 'none';
});

function checkCoupon() {
    const code = document.getElementById('coupon-input').value.trim();
    const resultDiv = document.getElementById('coupon-result');
    if (!code) return;
    
    fetch('{% url "orders:apply_coupon" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': getCookie('csrftoken') },
        body: `code=${encodeURIComponent(code)}`
    })
    .then(r => r.json())
    .then(data => {
        resultDiv.textContent = data.message;
        resultDiv.style.color = data.valid ? '#28a745' : '#dc3545';
    });
}

function getCookie(name) {
    let value = `; ${document.cookie}`;
    let parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}
</script>
{% endblock %}
